<!DOCTYPE html>
<html>
<body>
<h1>Staff App</h1>
<form id="actionForm">
    <label>Staff ID: <input name="staff_id" required></label><br>
    <label>Site: <select name="site" required>
        {% for site in sites %}
            <option value="{{ site }}">{{ site }}</option>
        {% endfor %}
    </select></label><br>
    <input type="hidden" name="lat" id="lat">
    <input type="hidden" name="lon" id="lon">
    <button type="submit" name="action" value="clock_in">Clock In</button>
    <button type="submit" name="action" value="clock_out">Clock Out</button><br>
    <label>Report: <input name="report"></label>
    <button type="submit" name="action" value="report">Submit Report</button>
</form>
<div id="result"></div>
<div id="error"></div>

<h2>View Hours</h2>
<form id="hoursForm">
    <label>From: <input type="date" name="from" required></label>
    <label>To: <input type="date" name="to" required></label>
    <button type="submit">View Hours</button>
</form>
<div id="hoursDisplay"></div>

<script>
document.getElementById('actionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const button = e.submitter;
    navigator.geolocation.getCurrentPosition(function(position) {
        const formData = new FormData(document.getElementById('actionForm'));
        formData.set('lat', position.coords.latitude);
        formData.set('lon', position.coords.longitude);
        formData.set('action', button.value);

        fetch('/', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) throw response;
            return response.json();
        })
        .then(data => {
            document.getElementById('result').innerText = data.message;
            document.getElementById('error').innerText = '';
        })
        .catch(error => {
            error.json().then(err => {
                document.getElementById('error').innerText = err.error;
                document.getElementById('result').innerText = '';
            });
        });
    }, function() {
        document.getElementById('error').innerText = 'Location access denied';
        document.getElementById('result').innerText = '';
    });
});

document.getElementById('hoursForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const url = `/hours?from=${formData.get('from')}&to=${formData.get('to')}`;
    fetch(url)
    .then(response => response.json())
    .then(data => {
        let hoursText = 'Total Hours:\n';
        for (let staff_id in data.hours) {
            hoursText += `${staff_id}: ${data.hours[staff_id].toFixed(2)} hours\n`;
        }
        document.getElementById('hoursDisplay').innerText = hoursText;
    })
    .catch(error => console.error('Error fetching hours:', error));
});
</script>
</body>
</html>